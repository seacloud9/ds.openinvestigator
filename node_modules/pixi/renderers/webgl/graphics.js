/**
 * pixi 0.1.0
 * http://drkibitz.github.io/node-pixi/
 * Copyright (c) 2013 Dr. Kibitz, http://drkibitz.com
 * Super fast 2D rendering engine for browserify, that uses WebGL with a context 2d fallback.
 * built: Thu Oct 03 2013 00:41:44 GMT-0700 (PDT)
 *
 * Pixi.js - v1.3.0
 * Copyright (c) 2012, Mat Groves
 */
"use strict";var shaders=require("./shaders"),globals=require("../../core/globals"),mat3=require("../../geom/matrix").mat3,hex2rgb=require("../../utils/color").hex2rgb,triangulate=require("../../utils/Polyk").triangulate,Point=require("../../geom/Point"),Graphics=require("../../primitives/Graphics");exports.renderGraphics=function(a,b){var c=globals.gl;a._webGL||(a._webGL={points:[],indices:[],lastIndex:0,buffer:c.createBuffer(),indexBuffer:c.createBuffer()}),a.dirty&&(a.dirty=!1,a.clearDirty&&(a.clearDirty=!1,a._webGL.lastIndex=0,a._webGL.points=[],a._webGL.indices=[]),exports.updateGraphics(a)),shaders.activatePrimitiveShader();var d=mat3.clone(a.worldTransform);mat3.transpose(d),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),c.uniformMatrix3fv(globals.primitiveProgram.translationMatrix,!1,d),c.uniform2f(globals.primitiveProgram.projectionVector,b.x,b.y),c.uniform1f(globals.primitiveProgram.alpha,a.worldAlpha),c.bindBuffer(c.ARRAY_BUFFER,a._webGL.buffer),c.vertexAttribPointer(globals.shaderProgram.vertexPositionAttribute,2,c.FLOAT,!1,0,0),c.vertexAttribPointer(globals.primitiveProgram.vertexPositionAttribute,2,c.FLOAT,!1,24,0),c.vertexAttribPointer(globals.primitiveProgram.colorAttribute,4,c.FLOAT,!1,24,8),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a._webGL.indexBuffer),c.drawElements(c.TRIANGLE_STRIP,a._webGL.indices.length,c.UNSIGNED_SHORT,0),shaders.activateDefaultShader()},exports.updateGraphics=function(a){for(var b=a._webGL.lastIndex;b<a.graphicsData.length;b++){var c=a.graphicsData[b];c.type==Graphics.POLY?(c.fill&&c.points.length>3&&exports.buildPoly(c,a._webGL),c.lineWidth>0&&exports.buildLine(c,a._webGL)):c.type==Graphics.RECT?exports.buildRectangle(c,a._webGL):(c.type==Graphics.CIRC||c.type==Graphics.ELIP)&&exports.buildCircle(c,a._webGL)}a._webGL.lastIndex=a.graphicsData.length;var d=globals.gl;a._webGL.glPoints=new Float32Array(a._webGL.points),d.bindBuffer(d.ARRAY_BUFFER,a._webGL.buffer),d.bufferData(d.ARRAY_BUFFER,a._webGL.glPoints,d.STATIC_DRAW),a._webGL.glIndicies=new Uint16Array(a._webGL.indices),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a._webGL.indexBuffer),d.bufferData(d.ELEMENT_ARRAY_BUFFER,a._webGL.glIndicies,d.STATIC_DRAW)},exports.buildRectangle=function(a,b){var c=a.points,d=c[0],e=c[1],f=c[2],g=c[3];if(a.fill){var h=hex2rgb(a.fillColor),i=a.fillAlpha,j=h[0]*i,k=h[1]*i,l=h[2]*i,m=b.points,n=b.indices,o=m.length/6;m.push(d,e),m.push(j,k,l,i),m.push(d+f,e),m.push(j,k,l,i),m.push(d,e+g),m.push(j,k,l,i),m.push(d+f,e+g),m.push(j,k,l,i),n.push(o,o,o+1,o+2,o+3,o+3)}a.lineWidth&&(a.points=[d,e,d+f,e,d+f,e+g,d,e+g,d,e],exports.buildLine(a,b))},exports.buildCircle=function(a,b){var c,d=a.points,e=d[0],f=d[1],g=d[2],h=d[3],i=40,j=2*Math.PI/i;if(a.fill){var k=hex2rgb(a.fillColor),l=a.fillAlpha,m=k[0]*l,n=k[1]*l,o=k[2]*l,p=b.points,q=b.indices,r=p.length/6;for(q.push(r),c=0;i+1>c;c++)p.push(e,f,m,n,o,l),p.push(e+Math.sin(j*c)*g,f+Math.cos(j*c)*h,m,n,o,l),q.push(r++,r++);q.push(r-1)}if(a.lineWidth){for(a.points=[],c=0;i+1>c;c++)a.points.push(e+Math.sin(j*c)*g,f+Math.cos(j*c)*h);exports.buildLine(a,b)}},exports.buildLine=function(a,b){var c=a.points;if(0!==c.length){var d=new Point(c[0],c[1]),e=new Point(c[c.length-2],c[c.length-1]);if(d.x==e.x&&d.y==e.y){c.pop(),c.pop(),e=new Point(c[c.length-2],c[c.length-1]);var f=e.x+.5*(d.x-e.x),g=e.y+.5*(d.y-e.y);c.unshift(f,g),c.push(f,g)}var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=b.points,F=b.indices,G=c.length/2,H=c.length,I=E.length/6,J=a.lineWidth/2,K=hex2rgb(a.lineColor),L=a.lineAlpha,M=K[0]*L,N=K[1]*L,O=K[2]*L;h=c[0],i=c[1],j=c[2],k=c[3],n=-(i-k),o=h-j,B=Math.sqrt(n*n+o*o),n/=B,o/=B,n*=J,o*=J,E.push(h-n,i-o,M,N,O,L),E.push(h+n,i+o,M,N,O,L);for(var P=1;G-1>P;P++)h=c[2*(P-1)],i=c[2*(P-1)+1],j=c[2*P],k=c[2*P+1],l=c[2*(P+1)],m=c[2*(P+1)+1],n=-(i-k),o=h-j,B=Math.sqrt(n*n+o*o),n/=B,o/=B,n*=J,o*=J,p=-(k-m),q=j-l,B=Math.sqrt(p*p+q*q),p/=B,q/=B,p*=J,q*=J,t=-o+i-(-o+k),u=-n+j-(-n+h),v=(-n+h)*(-o+k)-(-n+j)*(-o+i),w=-q+m-(-q+k),x=-p+j-(-p+l),y=(-p+l)*(-q+k)-(-p+j)*(-q+m),z=t*x-w*u,0===z&&(z+=1),C=(u*y-x*v)/z,D=(w*v-t*y)/z,A=(C-j)*(C-j)+(D-k)+(D-k),A>19600?(r=n-p,s=o-q,B=Math.sqrt(r*r+s*s),r/=B,s/=B,r*=J,s*=J,E.push(j-r,k-s),E.push(M,N,O,L),E.push(j+r,k+s),E.push(M,N,O,L),E.push(j-r,k-s),E.push(M,N,O,L),H++):(E.push(C,D),E.push(M,N,O,L),E.push(j-(C-j),k-(D-k)),E.push(M,N,O,L));for(h=c[2*(G-2)],i=c[2*(G-2)+1],j=c[2*(G-1)],k=c[2*(G-1)+1],n=-(i-k),o=h-j,B=Math.sqrt(n*n+o*o),n/=B,o/=B,n*=J,o*=J,E.push(j-n,k-o),E.push(M,N,O,L),E.push(j+n,k+o),E.push(M,N,O,L),F.push(I),P=0;H>P;P++)F.push(I++);F.push(I-1)}},exports.buildPoly=function(a,b){var c=a.points;if(!(c.length<6)){for(var d=b.points,e=b.indices,f=triangulate(c),g=d.length/6,h=0,i=f.length;i>h;h+=3)e.push(f[h]+g),e.push(f[h]+g),e.push(f[h+1]+g),e.push(f[h+2]+g),e.push(f[h+2]+g);var j=hex2rgb(a.fillColor),k=a.fillAlpha,l=j[0]*k,m=j[1]*k,n=j[2]*k;for(h=0,i=c.length/2;i>h;h++)d.push(c[2*h],c[2*h+1],l,m,n,k)}};